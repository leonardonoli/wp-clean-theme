// An html parser written in JavaScript
// Based on http://ejohn.org/blog/pure-javascript-html-parser/
//TODO(#39)
/*globals console:false*/
!function(){function t(t,o){t=t||"",o=o||{};for(var u in e)e.hasOwnProperty(u)&&(o.autoFix&&(o["fix_"+u]=!0),o.fix=o.fix||o["fix_"+u]);var c=[],f=document.createElement("div"),g=function(t){return"string"==typeof t&&-1!==t.indexOf("&")?(f.innerHTML=t,f.textContent||f.innerText||t):t},l=function(e){t+=e},m=function(e){t=e+t},p={comment:/^<!--/,endTag:/^<\//,atomicTag:/^<\s*(script|style|noscript|iframe|textarea)[\s\/>]/i,startTag:/^</,chars:/^[^<]/},T={comment:function(){var e=t.indexOf("-->");return e>=0?{content:t.substr(4,e-1),length:e+3}:void 0},endTag:function(){var e=t.match(a);return e?{tagName:e[1],length:e[0].length}:void 0},atomicTag:function(){var e=T.startTag();if(e){var n=t.slice(e.length);if(n.match(new RegExp("</\\s*"+e.tagName+"\\s*>","i"))){var a=n.match(new RegExp("([\\s\\S]*?)</\\s*"+e.tagName+"\\s*>","i"));if(a)return{tagName:e.tagName,attrs:e.attrs,content:a[1],length:a[0].length+e.length}}}},startTag:function(){var e=t.indexOf(">");if(-1===e)return null;var a=t.match(n);if(a){var i={},o={},u=a[2];return a[2].replace(r,function(t,e){if(arguments[2]||arguments[3]||arguments[4]||arguments[5])if(arguments[5])i[arguments[5]]="",o[e]=!0;else{var n=arguments[2]||arguments[3]||arguments[4]||s.test(e)&&e||"";i[e]=g(n)}else i[e]=null;u=u.replace(t,"")}),{tagName:a[1],attrs:i,booleanAttrs:o,rest:u,unary:!!a[3],length:a[0].length}}},chars:function(){var e=t.indexOf("<");return{length:e>=0?e:t.length}}},v=function(){for(var e in p)if(p[e].test(t)){i&&console.log("suspected "+e);var n=T[e]();return n?(i&&console.log("parsed "+e,n),n.type=n.type||e,n.text=t.substr(0,n.length),t=t.slice(n.length),n):null}},h=function(t){for(var e;e=v();)if(t[e.type]&&t[e.type](e)===!1)return},d=function(){var e=t;return t="",e},N=function(){return t};return o.fix&&!function(){var e=/^(AREA|BASE|BASEFONT|BR|COL|FRAME|HR|IMG|INPUT|ISINDEX|LINK|META|PARAM|EMBED)$/i,n=/^(COLGROUP|DD|DT|LI|OPTIONS|P|TD|TFOOT|TH|THEAD|TR)$/i,a=[];a.last=function(){return this[this.length-1]},a.lastTagNameEq=function(t){var e=this.last();return e&&e.tagName&&e.tagName.toUpperCase()===t.toUpperCase()},a.containsTagName=function(t){for(var e,n=0;e=this[n];n++)if(e.tagName===t)return!0;return!1};var r=function(t){return t&&"startTag"===t.type&&(t.unary=e.test(t.tagName)||t.unary,t.html5Unary=!/\/>$/.test(t.text)),t},s=v,i=function(){var e=t,n=r(s());return t=e,n},u=function(){var t=a.pop();m("</"+t.tagName+">")},c={startTag:function(t){var e=t.tagName;"TR"===e.toUpperCase()&&a.lastTagNameEq("TABLE")?(m("<TBODY>"),g()):o.fix_selfClose&&n.test(e)&&a.containsTagName(e)?a.lastTagNameEq(e)?u():(m("</"+t.tagName+">"),g()):t.unary||a.push(t)},endTag:function(t){var e=a.last();e?o.fix_tagSoup&&!a.lastTagNameEq(t.tagName)?u():a.pop():o.fix_tagSoup&&f()}},f=function(){s(),g()},g=function(){var t=i();t&&c[t.type]&&c[t.type](t)};v=function(){return g(),r(s())}}(),{append:l,readToken:v,readTokens:h,clear:d,rest:N,stack:c}}var e=function(){var t,e={},n=this.document.createElement("div");return t="<P><I></P></I>",n.innerHTML=t,e.tagSoup=n.innerHTML!==t,n.innerHTML="<P><i><P></P></i></P>",e.selfClose=2===n.childNodes.length,e}(),n=/^<([\-A-Za-z0-9_]+)((?:\s+[\w\-]+(?:\s*=?\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,a=/^<\/([\-A-Za-z0-9_]+)[^>]*>/,r=/(?:([\-A-Za-z0-9_]+)\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))|(?:([\-A-Za-z0-9_]+)(\s|$)+)/g,s=/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noresize|noshade|nowrap|readonly|selected)$/i,i=!1;t.supports=e,t.tokenToString=function(t){var e={comment:function(t){return"<!--"+t.content},endTag:function(t){return"</"+t.tagName+">"},atomicTag:function(t){return i&&console.log(t),e.startTag(t)+t.content+e.endTag(t)},startTag:function(t){var e="<"+t.tagName;for(var n in t.attrs){e+=" "+n;var a=t.attrs[n];("undefined"==typeof t.booleanAttrs||"undefined"==typeof t.booleanAttrs[n])&&(e+='="'+(a?a.replace(/(^|[^\\])"/g,'$1\\"'):"")+'"')}return t.rest&&(e+=t.rest),e+(t.unary&&!t.html5Unary?"/>":">")},chars:function(t){return t.text}};return e[t.type](t)},t.escapeAttributes=function(t){var e={};for(var n in t){var a=t[n];e[n]=a&&a.replace(/(^|[^\\])"/g,'$1\\"')}return e};for(var o in e)t.browserHasFlaw=t.browserHasFlaw||!e[o]&&o;this.htmlParser=t}();